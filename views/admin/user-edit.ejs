<%- include('../includes/head.ejs') %>

    <body class="bg-gray-50 min-h-screen">
        <%- include('../includes/navigation-admin.ejs') %>

            <main class="ml-64 min-h-screen bg-gray-50 py-8 px-4 pb-24">
                <div class="max-w-6xl mx-auto">
                    <!-- Header Section -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                                    <i class="ri-user-settings-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Ch·ªânh s·ª≠a t√†i kho·∫£n</h1>
                                    <p class="text-gray-600 mt-1">C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng</p>
                                </div>
                            </div>
                            <a href="/admin/accounts"
                                class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-3 rounded-xl font-medium hover:bg-gray-200 transition-all duration-200 hover:shadow-md">
                                <i class="ri-arrow-left-line"></i>
                                <span class="hidden sm:inline">Quay l·∫°i</span>
                            </a>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Form Section -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <!-- Form Header -->
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-4">
                                    <h2 class="text-white font-semibold text-lg">Th√¥ng tin c∆° b·∫£n</h2>
                                    <p class="text-blue-100 text-sm mt-1">C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n v√† quy·ªÅn h·∫°n</p>
                                </div>

                                <div class="p-6">
                                    <% if (error) { %>
                                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                                            <div class="flex items-center gap-2">
                                                <i class="ri-error-warning-line text-red-500"></i>
                                                <span class="text-red-700 font-medium">
                                                    <%= error %>
                                                </span>
                                            </div>
                                        </div>
                                        <% } %>

                                            <% if (success) { %>
                                                <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl">
                                                    <div class="flex items-center gap-2">
                                                        <i class="ri-check-line text-green-500"></i>
                                                        <span class="text-green-700 font-medium">
                                                            <%= success %>
                                                        </span>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <form action="/admin/accounts/<%= user._id %>/edit" method="POST"
                                                        class="space-y-6">
                                                        <!-- Basic Information -->
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                            <div class="space-y-2">
                                                                <label for="name"
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i class="ri-user-line mr-2 text-blue-500"></i>
                                                                    H·ªç v√† t√™n
                                                                </label>
                                                                <input type="text" name="name" value="<%= user.name %>"
                                                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                                    placeholder="Nh·∫≠p h·ªç v√† t√™n..." required>
                                                            </div>

                                                            <div class="space-y-2">
                                                                <label for="email"
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i class="ri-mail-line mr-2 text-green-500"></i>
                                                                    Email
                                                                </label>
                                                                <input type="email" name="email"
                                                                    value="<%= user.email %>"
                                                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                                    placeholder="example@email.com" required>
                                                            </div>
                                                        </div>

                                                        <!-- Role and Status -->
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                            <div class="space-y-2">
                                                                <label for="role"
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i
                                                                        class="ri-shield-user-line mr-2 text-purple-500"></i>
                                                                    Vai tr√≤
                                                                </label>
                                                                <select name="role"
                                                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white">
                                                                    <option value="user" <%=user.role==='user'
                                                                        ? 'selected' : '' %>>üë§ Ng∆∞·ªùi d√πng</option>
                                                                    <option value="admin" <%=user.role==='admin'
                                                                        ? 'selected' : '' %>>üëë Qu·∫£n tr·ªã vi√™n</option>
                                                                </select>
                                                            </div>

                                                            <div class="space-y-2">
                                                                <label
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i class="ri-toggle-line mr-2 text-orange-500"></i>
                                                                    Tr·∫°ng th√°i t√†i kho·∫£n
                                                                </label>
                                                                <div class="flex items-center gap-3">
                                                                    <label
                                                                        class="flex items-center gap-2 cursor-pointer">
                                                                        <input type="radio" name="status" value="active"
                                                                            <%=user.status !=='suspended' ? 'checked'
                                                                            : '' %>
                                                                        class="text-blue-500 focus:ring-blue-500"
                                                                        >
                                                                        <span class="text-sm">Ho·∫°t ƒë·ªông</span>
                                                                    </label>
                                                                    <label
                                                                        class="flex items-center gap-2 cursor-pointer">
                                                                        <input type="radio" name="status"
                                                                            value="suspended"
                                                                            <%=user.status==='suspended' ? 'checked'
                                                                            : '' %>
                                                                        class="text-red-500 focus:ring-red-500"
                                                                        >
                                                                        <span class="text-sm">T·∫°m kh√≥a</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Additional Information -->
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                            <div class="space-y-2">
                                                                <label for="phone"
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i class="ri-phone-line mr-2 text-blue-500"></i>
                                                                    S·ªë ƒëi·ªán tho·∫°i
                                                                </label>
                                                                <input type="tel" name="phone"
                                                                    value="<%= user.phone || '' %>"
                                                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                                    placeholder="0123456789">
                                                            </div>

                                                            <div class="space-y-2">
                                                                <label for="address"
                                                                    class="block text-sm font-semibold text-gray-700">
                                                                    <i class="ri-map-pin-line mr-2 text-green-500"></i>
                                                                    ƒê·ªãa ch·ªâ
                                                                </label>
                                                                <input type="text" name="address"
                                                                    value="<%= user.address || '' %>"
                                                                    class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                                    placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ...">
                                                            </div>
                                                        </div>

                                                        <!-- Action Buttons -->
                                                        <div
                                                            class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-6 border-t border-gray-200">
                                                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                                                <i class="ri-information-line"></i>
                                                                <span>Thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c</span>
                                                            </div>
                                                            <div class="flex items-center gap-3">
                                                                <a href="/admin/accounts"
                                                                    class="px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-all duration-200 hover:shadow-md">
                                                                    <i class="ri-close-line mr-2"></i>
                                                                    Hu·ª∑
                                                                </a>
                                                                <button type="submit"
                                                                    class="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 hover:shadow-lg transform hover:scale-105 flex items-center gap-2">
                                                                    <i class="ri-save-line"></i>
                                                                    L∆∞u thay ƒë·ªïi
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </form>
                                </div>
                            </div>

                            <!-- Change Password Section -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden mt-8">
                                <div class="bg-gradient-to-r from-orange-500 to-red-600 px-6 py-4">
                                    <h2 class="text-white font-semibold text-lg">ƒê·ªïi m·∫≠t kh·∫©u</h2>
                                    <p class="text-orange-100 text-sm mt-1">T·∫°o m·∫≠t kh·∫©u m·ªõi cho ng∆∞·ªùi d√πng</p>
                                </div>

                                <div class="p-6">
                                    <form action="/admin/accounts/<%= user._id %>/change-password" method="POST"
                                        class="space-y-6" id="changePasswordForm">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="space-y-2">
                                                <label for="newPassword"
                                                    class="block text-sm font-semibold text-gray-700">
                                                    <i class="ri-lock-line mr-2 text-orange-500"></i>
                                                    M·∫≠t kh·∫©u m·ªõi
                                                </label>
                                                <div class="relative">
                                                    <input type="password" name="newPassword" id="newPassword"
                                                        class="w-full border border-gray-300 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..." autocomplete="new-password">
                                                    <button type="button" onclick="togglePassword('newPassword')"
                                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                        <i class="ri-eye-line" id="newPasswordIcon"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="space-y-2">
                                                <label for="confirmPassword"
                                                    class="block text-sm font-semibold text-gray-700">
                                                    <i class="ri-lock-password-line mr-2 text-red-500"></i>
                                                    X√°c nh·∫≠n m·∫≠t kh·∫©u
                                                </label>
                                                <div class="relative">
                                                    <input type="password" name="confirmPassword" id="confirmPassword"
                                                        class="w-full border border-gray-300 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u..." autocomplete="new-password">
                                                    <button type="button" onclick="togglePassword('confirmPassword')"
                                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                        <i class="ri-eye-line" id="confirmPasswordIcon"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                                <i class="ri-information-line"></i>
                                                <span>M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±</span>
                                            </div>
                                            <button type="submit" id="changePasswordBtn"
                                                class="px-6 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 text-white font-semibold hover:from-orange-600 hover:to-red-700 transition-all duration-200 hover:shadow-lg transform hover:scale-105 flex items-center gap-2">
                                                <i class="ri-key-line"></i>
                                                ƒê·ªïi m·∫≠t kh·∫©u
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- User Information Sidebar -->
                        <div class="space-y-6">
                            <!-- User Profile Card -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-4">
                                    <h2 class="text-white font-semibold text-lg">Th√¥ng tin t√†i kho·∫£n</h2>
                                </div>
                                <div class="p-6">
                                    <div class="text-center mb-6">
                                        <div
                                            class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span class="text-white text-2xl font-bold">
                                                <%= user.name.charAt(0).toUpperCase() %>
                                            </span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">
                                            <%= user.name %>
                                        </h3>
                                        <p class="text-gray-600 text-sm">
                                            <%= user.email %>
                                        </p>
                                    </div>

                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">Vai tr√≤:</span>
                                            <span
                                                class="text-sm font-medium <%= user.role === 'admin' ? 'text-purple-600' : 'text-blue-600' %>">
                                                <%= user.role==='admin' ? 'üëë Admin' : 'üë§ User' %>
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">Tr·∫°ng th√°i:</span>
                                            <span
                                                class="text-sm font-medium <%= user.status === 'suspended' ? 'text-red-600' : 'text-green-600' %>">
                                                <%= user.status==='suspended' ? 'üö´ ƒê√£ kh√≥a' : '‚úÖ Ho·∫°t ƒë·ªông' %>
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">Ng√†y t·∫°o:</span>
                                            <span class="text-sm font-medium text-gray-800">
                                                <%= new Date(user.createdAt).toLocaleDateString('vi-VN') %>
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</span>
                                            <span class="text-sm font-medium text-gray-800">
                                                <%= new Date(user.updatedAt ||
                                                    user.createdAt).toLocaleDateString('vi-VN') %>
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-sm text-gray-600">ID:</span>
                                            <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                                <%= user._id %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Statistics -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-green-500 to-teal-600 px-6 py-4">
                                    <h2 class="text-white font-semibold text-lg">Th·ªëng k√™ ho·∫°t ƒë·ªông</h2>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">ƒê∆°n h√†ng:</span>
                                            <span class="text-sm font-medium text-green-600">
                                                <%= user.orderCount || 0 %> ƒë∆°n
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">T·ªïng chi ti√™u:</span>
                                            <span class="text-sm font-medium text-green-600">
                                                <%= (user.totalSpent || 0).toLocaleString('vi-VN') %>ƒë
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-sm text-gray-600">ƒê√°nh gi√°:</span>
                                            <span class="text-sm font-medium text-blue-600">
                                                <%= user.reviewCount || 0 %> ƒë√°nh gi√°
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-sm text-gray-600">Y√™u th√≠ch:</span>
                                            <span class="text-sm font-medium text-red-600">
                                                <%= user.favoriteCount || 0 %> s·∫£n ph·∫©m
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
                                    <h2 class="text-white font-semibold text-lg">Thao t√°c nhanh</h2>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-3">
                                        <a href="/admin/orders?user=<%= user._id %>"
                                            class="flex items-center gap-3 p-3 rounded-xl bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors duration-200">
                                            <i class="ri-shopping-bag-line text-lg"></i>
                                            <span class="text-sm font-medium">Xem ƒë∆°n h√†ng</span>
                                        </a>
                                        <a href="/admin/reviews?user=<%= user._id %>"
                                            class="flex items-center gap-3 p-3 rounded-xl bg-green-50 text-green-700 hover:bg-green-100 transition-colors duration-200">
                                            <i class="ri-star-line text-lg"></i>
                                            <span class="text-sm font-medium">Xem ƒë√°nh gi√°</span>
                                        </a>
                                        <button onclick="sendWelcomeEmail('<%= user._id %>')"
                                            class="w-full flex items-center gap-3 p-3 rounded-xl bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors duration-200">
                                            <i class="ri-mail-send-line text-lg"></i>
                                            <span class="text-sm font-medium">G·ª≠i email ch√†o</span>
                                        </button>
                                        <button onclick="resetUserPassword('<%= user._id %>')"
                                            class="w-full flex items-center gap-3 p-3 rounded-xl bg-orange-50 text-orange-700 hover:bg-orange-100 transition-colors duration-200">
                                            <i class="ri-refresh-line text-lg"></i>
                                            <span class="text-sm font-medium">Reset m·∫≠t kh·∫©u</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <script>
                // Toggle password visibility
                function togglePassword(inputId) {
                    const input = document.getElementById(inputId);
                    const icon = document.getElementById(inputId + 'Icon');

                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('ri-eye-line');
                        icon.classList.add('ri-eye-off-line');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('ri-eye-off-line');
                        icon.classList.add('ri-eye-line');
                    }
                }

                // Simple form validation for other forms (exclude password form)
                document.querySelectorAll('form:not(#changePasswordForm)').forEach(form => {
                    form.addEventListener('submit', function (e) {
                        const requiredFields = form.querySelectorAll('[required]');
                        let isValid = true;

                        requiredFields.forEach(field => {
                            if (!field.value.trim()) {
                                isValid = false;
                                field.classList.add('border-red-500');
                                field.addEventListener('input', function () {
                                    this.classList.remove('border-red-500');
                                }, { once: true });
                            }
                        });

                        if (!isValid) {
                            e.preventDefault();
                            if (typeof showToast === 'function') {
                                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
                            } else {
                                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                            }
                        }
                    });
                });

                // Password change form handler
                document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
                    e.preventDefault();

                    console.log('Password form submitted');

                    // Get form elements
                    const newPasswordInput = document.getElementById('newPassword');
                    const confirmPasswordInput = document.getElementById('confirmPassword');
                    const submitBtn = document.getElementById('changePasswordBtn');

                    // Get values
                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    console.log('Password values:', {
                        newPasswordLength: newPassword.length,
                        confirmPasswordLength: confirmPassword.length,
                        newPasswordEmpty: newPassword === '',
                        confirmPasswordEmpty: confirmPassword === ''
                    });

                    // Reset error states
                    newPasswordInput.classList.remove('border-red-500');
                    confirmPasswordInput.classList.remove('border-red-500');

                    // Validation
                    if (!newPassword) {
                        console.log('New password is empty');
                        newPasswordInput.classList.add('border-red-500');
                        newPasswordInput.focus();
                        if (typeof showToast === 'function') {
                            showToast('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi', 'error');
                        } else {
                            alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi');
                        }
                        return;
                    }

                    if (newPassword.length < 6) {
                        console.log('Password too short');
                        newPasswordInput.classList.add('border-red-500');
                        newPasswordInput.focus();
                        if (typeof showToast === 'function') {
                            showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
                        } else {
                            alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
                        }
                        return;
                    }

                    if (!confirmPassword) {
                        console.log('Confirm password is empty');
                        confirmPasswordInput.classList.add('border-red-500');
                        confirmPasswordInput.focus();
                        if (typeof showToast === 'function') {
                            showToast('Vui l√≤ng nh·∫≠p x√°c nh·∫≠n m·∫≠t kh·∫©u', 'error');
                        } else {
                            alert('Vui l√≤ng nh·∫≠p x√°c nh·∫≠n m·∫≠t kh·∫©u');
                        }
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        console.log('Passwords do not match');
                        confirmPasswordInput.classList.add('border-red-500');
                        confirmPasswordInput.focus();
                        if (typeof showToast === 'function') {
                            showToast('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                        } else {
                            alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
                        }
                        return;
                    }

                    console.log('All validations passed, submitting...');

                    // Show loading
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> ƒêang x·ª≠ l√Ω...';

                    // Prepare data
                    const formData = new URLSearchParams();
                    formData.append('newPassword', newPassword);
                    formData.append('confirmPassword', confirmPassword);

                    // Submit
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            console.log('Response received:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Response data:', data);
                            if (data.success) {
                                if (typeof showToast === 'function') {
                                    showToast(data.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng', 'success');
                                } else {
                                    alert(data.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
                                }
                                // Reset form
                                this.reset();
                            } else {
                                if (typeof showToast === 'function') {
                                    showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                                } else {
                                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            if (typeof showToast === 'function') {
                                showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
                            } else {
                                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                            }
                        })
                        .finally(() => {
                            // Restore button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        });
                });

                // Clear error styling on input
                document.getElementById('newPassword').addEventListener('input', function () {
                    this.classList.remove('border-red-500');
                    console.log('New password input changed, length:', this.value.length);
                });

                document.getElementById('confirmPassword').addEventListener('input', function () {
                    this.classList.remove('border-red-500');
                    console.log('Confirm password input changed, length:', this.value.length);
                });

                // Quick action functions
                function sendWelcomeEmail(userId) {
                    if (confirm('G·ª≠i email ch√†o m·ª´ng cho ng∆∞·ªùi d√πng n√†y?')) {
                        fetch(`/admin/accounts/${userId}/send-welcome-email`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    if (typeof showToast === 'function') {
                                        showToast('Email ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng', 'success');
                                    } else {
                                        alert('Email ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng');
                                    }
                                } else {
                                    if (typeof showToast === 'function') {
                                        showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                                    } else {
                                        alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                                    }
                                }
                            })
                            .catch(error => {
                                if (typeof showToast === 'function') {
                                    showToast('C√≥ l·ªói x·∫£y ra khi g·ª≠i email', 'error');
                                } else {
                                    alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i email');
                                }
                            });
                    }
                }

                function resetUserPassword(userId) {
                    if (confirm('Reset m·∫≠t kh·∫©u cho ng∆∞·ªùi d√πng n√†y? M·∫≠t kh·∫©u m·ªõi s·∫Ω ƒë∆∞·ª£c g·ª≠i qua email.')) {
                        fetch(`/admin/accounts/${userId}/reset-password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    if (typeof showToast === 'function') {
                                        showToast('M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c reset v√† g·ª≠i qua email', 'success');
                                    } else {
                                        alert('M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c reset v√† g·ª≠i qua email');
                                    }
                                } else {
                                    if (typeof showToast === 'function') {
                                        showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                                    } else {
                                        alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                                    }
                                }
                            })
                            .catch(error => {
                                if (typeof showToast === 'function') {
                                    showToast('C√≥ l·ªói x·∫£y ra khi reset m·∫≠t kh·∫©u', 'error');
                                } else {
                                    alert('C√≥ l·ªói x·∫£y ra khi reset m·∫≠t kh·∫©u');
                                }
                            });
                    }
                }
            </script>

            <%- include('../includes/end.ejs') %>